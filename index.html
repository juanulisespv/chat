<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat con PDF y OpenAI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f7f7f7; }
    .container { background: #fff; padding: 0; border-radius: 8px; max-width: 600px; margin: 2em auto; box-shadow: 0 2px 8px #0001; display: flex; flex-direction: column; height: 80vh; }
    .chat-header { padding: 1.5em 2em 1em 2em; border-bottom: 1px solid #eee; }
    .chat-history { flex: 1; overflow-y: auto; padding: 2em; background: #f4f6fb; display: flex; flex-direction: column; gap: 1em; }
    .msg { max-width: 80%; padding: 1em; border-radius: 12px; font-size: 1em; line-height: 1.5; word-break: break-word; }
    .msg.user { align-self: flex-end; background: #007bff; color: #fff; border-bottom-right-radius: 2px; }
    .msg.assistant { align-self: flex-start; background: #e9ecef; color: #222; border-bottom-left-radius: 2px; }
    .chat-input-area { display: flex; flex-direction: column; gap: 0.5em; padding: 1em 2em 2em 2em; border-top: 1px solid #eee; background: #fff; }
    .chat-input-row { display: flex; gap: 0.5em; }
    .chat-input { flex: 1; padding: 0.75em; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
    .chat-btn { padding: 0.75em 1.5em; border: none; background: #007bff; color: #fff; border-radius: 6px; cursor: pointer; font-size: 1em; }
    .chat-btn:disabled { background: #aaa; }
    .file-upload { margin-bottom: 0.5em; }
    @media (max-width: 700px) {
      .container { max-width: 100vw; height: 100vh; border-radius: 0; }
      .chat-header, .chat-history, .chat-input-area { padding-left: 1em; padding-right: 1em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="chat-header">
      <h2 style="margin:0;">Chat con tu PDF usando OpenAI</h2>
      <input class="file-upload" type="file" id="pdfInput" accept="application/pdf">
      <span id="fileName" style="font-size:0.95em;color:#555;"></span>
      <input type="text" id="urlInput" placeholder="O pega aquí una URL (opcional)" style="width:100%;margin-top:0.5em;padding:0.5em;border-radius:6px;border:1px solid #ccc;">
    </div>
    <div id="chatHistory" class="chat-history"></div>
    <form id="pdfForm" class="chat-input-area">
      <div class="chat-input-row">
        <textarea id="pregunta" class="chat-input" placeholder="Escribe tu pregunta..." required></textarea>
        <button type="submit" class="chat-btn">Enviar</button>
      </div>
    </form>
    <div id="respuesta" class="respuesta" style="display:none;"></div>
  </div>
  <script>
    // 1. Generar o recuperar sessionId único por usuario
    function getSessionId() {
      let sessionId = localStorage.getItem('sessionId');
      if (!sessionId) {
        sessionId = 'sess-' + Math.random().toString(36).substring(2) + Date.now();
        localStorage.setItem('sessionId', sessionId);
      }
      return sessionId;
    }

    const form = document.getElementById('pdfForm');
    const respuestaDiv = document.getElementById('respuesta');
    const chatHistoryDiv = document.getElementById('chatHistory');
    const fileInput = document.getElementById('pdfInput');
    const fileNameSpan = document.getElementById('fileName');
    let historial = [];
    let pdfFile = null;

    fileInput.addEventListener('change', (e) => {
      pdfFile = e.target.files[0];
      fileNameSpan.textContent = pdfFile ? pdfFile.name : '';
    });

    form.onsubmit = async (e) => {
      e.preventDefault();
      await enviarPregunta();
    };

    // Permitir enviar con Enter y salto de línea con Shift+Enter
    document.getElementById('pregunta').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    async function enviarPregunta() {
      respuestaDiv.style.display = 'none';
      respuestaDiv.textContent = '';
      const pregunta = document.getElementById('pregunta').value;
      const url = document.getElementById('urlInput').value.trim();
      if (!pregunta) return;
      const formData = new FormData();
      if (pdfFile) formData.append('pdf', pdfFile);
      if (url) formData.append('url', url);
      formData.append('pregunta', pregunta);
      formData.append('sessionId', getSessionId());
      form.querySelector('button').disabled = true;
      try {
        historial.push({ role: 'user', content: pregunta });
        renderChatHistory();
        const res = await fetch('/api/consultar', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.respuesta) {
          historial.push({ role: 'assistant', content: data.respuesta });
        }
        renderChatHistory();
        respuestaDiv.textContent = data.respuesta || 'No se obtuvo respuesta.';
        respuestaDiv.style.display = data.respuesta ? 'none' : 'block';
        document.getElementById('pregunta').value = '';
        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
      } catch (err) {
        respuestaDiv.textContent = 'Error al consultar.';
        respuestaDiv.style.display = 'block';
      }
      form.querySelector('button').disabled = false;
    }

    function renderChatHistory() {
      chatHistoryDiv.innerHTML = '';
      historial.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'msg ' + (msg.role === 'user' ? 'user' : 'assistant');
        div.innerHTML = msg.content;
        chatHistoryDiv.appendChild(div);
      });
      chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
    }
  </script>
</body>
</html>
